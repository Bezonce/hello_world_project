#      # Replace $PROJECT_ID with your project ID
#      PROJECT_ID: "hello-world-flask-390916"
#      IMAGE_NAME: "gcr.io/hello-world-flask-390916/app"
#      AR_REGION:
#      GAR_REPO_NAME:
#
#      - name: Authenticate to Google Cloud
#        uses: google-github-actions/auth@v0
#        with:
#          # Replace with your Workload Identity Provider Location
#          workload_identity_provider: 'projects/65253733312/locations/global/workloadIdentityPools/gh-pool/providers/gh-provider'
#          # Replace with your GitHub Service Account
#          service_account: 'github-actions-service-account@hello-world-flask-390916.iam.gserviceaccount.com'
on:
  push:
    branches:
      - Dockerisation

env:
  PROJECT_ID: hello-world-flask-390916
  LOCATION: europe-central2
  REPO_NAME: hello-world-flask-390916/hello-world-flask

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Google Cloud SDK
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: 'projects/65253733312/locations/global/workloadIdentityPools/gh-pool/providers/gh-provider'
          service_account: 'github-actions-service-account@hello-world-flask-390916.iam.gserviceaccount.com'

      - name: Authenticate with Workload Identity Provider
        id: auth
        run: |
          gcloud container clusters get-credentials your-cluster-name \
            --region ${{ env.LOCATION }} \
            --project ${{ env.PROJECT_ID }}
          gcloud auth configure-docker --quiet

      - name: Build and Push Docker image
        run: |
          docker build -t gcr.io/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }} .
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }}

      - name: Create Artifact Registry repository
        run: |
          gcloud artifacts repositories create ${{ env.REPO_NAME }} \
            --repository-format=docker \
            --location=${{ env.LOCATION }} \
            --project=${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.LOCATION }}-docker.pkg.dev \
            --project=${{ env.PROJECT_ID }}

      - name: Push Docker image to Artifact Registry
        run: |
          docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }} \
            ${{ env.LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }}
          docker push ${{ env.LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}:${{ github.sha }}
